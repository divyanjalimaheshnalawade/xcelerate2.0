<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Career Insights - Xcelerate</title>
    <link
      rel="shortcut icon"
      href="../images/XcerelateIcon.png"
      type="image/x-icon"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://unpkg.com/lucide-static@latest/font/lucide.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-[#1b1b1b] text-white min-h-screen flex flex-col">
    <!-- Top Navbar -->
    <nav
      class="bg-[#202020] flex justify-between items-center px-6 py-2 shadow-md"
    >
      <div class="flex items-center space-x-4">
        <a href="../pages/login.html"
          ><img
            src="../images/Ultimatixlogo.png"
            alt="Ultimatix Logo"
            class="w-[120px]"
        /></a>
        <a href="xcelerate.html"
          ><img
            src="../images/Xcelerate-NBG.png"
            alt="Xcelerate Logo"
            class="w-[120px]"
        /></a>
      </div>

      <div class="flex items-center space-x-4 text-gray-300">
        <input
          type="search"
          id="search"
          placeholder="Search..."
          class="ml-4 px-3 py-1 rounded-md bg-[#1b1b1b] border border-gray-600 text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400"
        />
        <a href="notifications.html"
          ><img
            src="../images/icon_notification_none.png"
            alt="Notifications Icon"
            class="w-6 h-6"
        /></a>
        <a href="myProfile.html"
          ><img
            src="../images/icon_profile.png"
            alt="Profile Icon"
            class="w-6 h-6"
        /></a>
        <a href="../pages/login.html"
          ><img
            src="../images/icon_logout.png"
            alt="Logout Icon"
            class="w-6 h-6"
        /></a>
      </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="bg-[#2b2b2b] w-20 flex flex-col items-center py-4 space-y-5"
      >
        <a
          href="xcelerate.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/homepage.png"
            class="w-6 h-6 mb-1"
            alt="Dashboard"
          /><span class="text-center">Dashboard</span></a
        >
        <a
          href="aspiredRole.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/aspireicon.png"
            class="w-6 h-6 mb-1"
            alt="Aspired Role Icon"
          /><span class="text-center">Your Aspire Role</span></a
        >
        <a
          href="currentOpenings.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/open.jpg"
            class="w-6 h-6 mb-1"
            alt="Openings Icon"
          /><span class="text-center">Current Openings</span></a
        >
        <a
          href="careerInsights.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/carrierInsight.png"
            class="w-6 h-6 mb-1"
            alt="Insights Icon"
          /><span class="text-center">Career Insights</span></a
        >
        <a
          href="careerStreams.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/icon-career-streams.png"
            class="w-6 h-6 mb-1"
            alt="Streams Icon"
          /><span class="text-center">Career Streams</span></a
        >
        <a
          href="https://digitalprofile.ultimatix.net/DigitalProfile/#/profile"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/new_profile_img.png"
            class="w-6 h-6 mb-1"
            alt="Profile Icon"
          /><span class="text-center">Profile</span></a
        >
        <a
          href="findMentor.html"
          class="sidebar-link flex flex-col items-center text-gray-300 text-xs w-full py-2"
          ><img
            src="../images/findMentor.png"
            class="w-6 h-6 mb-1"
            alt="Mentor Icon"
          /><span class="text-center">Find Your Mentor</span></a
        >
      </aside>

      <!-- MAIN CONTENT -->
      <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-2xl font-bold mb-6">Career Insights</h1>

        <!-- üî• NEW REPLACED AI DASHBOARD -->
        <div class="space-y-6">
          <!-- üü° Skill Gap -->
          <div
            class="bg-[#2b2b2b] p-6 rounded-xl shadow-lg border border-gray-700"
          >
            <h2
              class="font-semibold text-xl mb-3 text-yellow-400 flex items-center gap-2"
            >
              <i class="lucide lucide-zap"></i> Skill Gap Analysis
            </h2>
            <div id="skillGapContent" class="text-gray-300 text-sm">
              <p class="animate-pulse text-gray-500">
                ‚è≥ Loading your skill gap...
              </p>
            </div>
          </div>

          <!-- üîµ Matching Roles -->
          <div
            class="bg-[#2b2b2b] p-6 rounded-xl shadow-lg border border-gray-700"
          >
            <h2
              class="font-semibold text-xl mb-3 text-blue-400 flex items-center gap-2"
            >
              <i class="lucide lucide-briefcase"></i> Matching Roles
            </h2>
            <p class="text-gray-400 text-sm mb-2">
              Jobs aligned with your skills.
            </p>
            <div
              id="matchingRolesContent"
              class="text-gray-300 text-sm space-y-2"
            >
              <p class="animate-pulse text-gray-500">
                ‚è≥ Fetching matching roles...
              </p>
            </div>
          </div>

          <!-- üü¢ Learning Path -->
          <div
            class="bg-[#2b2b2b] p-6 rounded-xl shadow-lg border border-gray-700"
          >
            <h2
              class="font-semibold text-xl mb-3 text-green-400 flex items-center gap-2"
            >
              <i class="lucide lucide-graduation-cap"></i> Learning Path
              Recommendations
            </h2>
            <div
              id="learningPathContent"
              class="text-gray-300 text-sm space-y-2"
            >
              <p class="animate-pulse text-gray-500">
                ‚è≥ Generating personalized learning path...
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- FOOTER -->
    <footer
      class="bg-[#202020] text-gray-400 text-sm border-t border-gray-700 w-full flex justify-between items-center py-3 px-6"
    >
      <img src="../images/TCS_White_2024.png" class="h-6" />

      <div class="text-right text-xs">
        <a href="#" class="hover:text-white">Third Party Notices</a> |
        <a href="#" class="hover:text-white">Privacy Policy</a> |
        <a href="#" class="hover:text-white">Terms of Use</a> |
        <a href="#" class="hover:text-white">Display Compatibility</a>
        <p class="mt-1">¬© 2025 Tata Consultancy Services</p>
      </div>
    </footer>

    <script>
      // small helper: safe text
      function esc(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      async function loadCareerInsights() {
        try {
          // 1) Get latest aspired role (your aspiredRoleRoutes GET "/" returns latest)
          let aspiredRole = null;
          try {
            const r = await fetch("http://localhost:4000/api/aspired-role");
            if (r.ok) {
              const json = await r.json();
              // try multiple possible fields
              aspiredRole =
                json.aspiredRole ||
                json.aspired_role ||
                json.role ||
                json.title ||
                json.name ||
                null;
            }
          } catch (err) {
            console.warn("Could not fetch latest aspired role:", err);
          }

          // If no aspired role found, show message
          if (!aspiredRole) {
            document.getElementById("skillGapContent").innerHTML = `
          <p class="text-gray-400">No aspired role found. Please set your aspired role first.</p>
        `;
            return;
          }

          // 2) Ask backend to analyze (CSV-based endpoint)
          const analyzeRes = await fetch(
            "http://localhost:4000/api/skill-gap/analyze",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ aspiredRole }),
            }
          );

          if (!analyzeRes.ok) throw new Error("Skill gap API error");
          const data = await analyzeRes.json();

          // Render skill gap
          const match = data.matchPercentage ?? data.matchPct ?? 0;
          const missing = data.missingSkills ?? data.missing ?? [];
          const required = data.requiredSkills ?? data.requiredSkills ?? [];
          const userSkills = data.userSkills ?? data.userSkills ?? [];

          document.getElementById("skillGapContent").innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-400">Aspired Role</p>
            <p class="font-semibold text-lg">${esc(aspiredRole)}</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-400">Match</p>
            <p class="font-bold text-2xl text-yellow-400">${esc(match)}%</p>
          </div>
        </div>

        <div class="mt-3 text-sm text-gray-300">
          <p><strong>Current Skills:</strong> ${esc(
            userSkills.join(", ") || "None"
          )}</p>
          <p class="mt-1"><strong>Required Skills:</strong> ${esc(
            required.join(", ") || "None"
          )}</p>
          <p class="mt-1"><strong>Missing:</strong> ${
            missing.length
              ? esc(missing.join(", "))
              : "<span class='text-green-400'>None</span>"
          }</p>
        </div>

        <div class="mt-4">
          <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
            <div style="width: ${match}%" class="h-3 bg-yellow-400 rounded-full"></div>
          </div>
        </div>
      `;

          // store missingSkills for learning path
          window.__missingSkills = missing.map((m) => String(m).toLowerCase());
          window.__userSkills = userSkills.map((s) => String(s).toLowerCase());
        } catch (err) {
          console.error("Career insights load failed:", err);
          document.getElementById("skillGapContent").innerHTML =
            '<p class="text-red-400">‚ùå Unable to load skill gap analysis.</p>';
        }
      }

      async function loadMatchingRoles() {
        try {
          const res = await fetch(
            "http://localhost:4000/api/skill-gap/matching-roles"
          );
          if (!res.ok) throw new Error("Match roles API error");
          const data = await res.json();

          const container = document.getElementById("matchingRolesContent");
          container.innerHTML = ""; // clear

          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = `<p class="text-gray-400">No matching roles found.</p>`;
            return;
          }

          container.innerHTML = `
        <div class="grid grid-cols-1 gap-2">
          ${data
            .map(
              (r) => `
            <div class="mb-2 p-3 bg-[#1f1f1f] rounded-md">
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-semibold text-sm">${esc(
                    r.role || r.Role || "Role"
                  )}</p>
                  <p class="text-xs text-gray-400">${esc(
                    (r.totalRequired || r.totalRequired) + " required"
                  )}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold">${esc(
                    r.matchPercentage ?? r.matchPct ?? 0
                  )}%</p>
                </div>
              </div>
              <p class="text-xs text-gray-400 mt-2">Missing: ${esc(
                (r.missingSkills || r.missing || []).join(", ") || "None"
              )}</p>
            </div>`
            )
            .join("")}
        </div>
      `;
        } catch (err) {
          console.error("loadMatchingRoles error:", err);
          const container = document.getElementById("matchingRolesContent");
          container.innerHTML = `<p class="text-red-400">‚ùå Unable to load matching roles.</p>`;
        }
      }

      async function loadLearningPaths() {
        try {
          const missing = window.__missingSkills || [
            "javascript",
            "sql",
            "react",
            "node.js",
          ];

          // local fallback mapping (mirrors backend/services/matching.js)
          const sampleResources = {
            javascript: [
              "JavaScript Fundamentals - MDN (developer.mozilla.org)",
              "FreeCodeCamp JS Course - freecodecamp.org",
            ],
            sql: ["SQL Basics - W3Schools", "Kaggle SQL Tutorial - kaggle.com"],
            react: [
              "React Official Docs - react.dev",
              "React Crash Course (YouTube)",
            ],
            "node.js": [
              "Node.js Crash Course (YouTube)",
              "Node.js Guide - nodejs.dev",
            ],
          };

          const content = document.getElementById("learningPathContent");
          content.innerHTML = "";

          missing.forEach((ms) => {
            const m = String(ms).toLowerCase();
            const courses = sampleResources[m] || [
              `Search for "${m}" on Google for top resources.`,
            ];
            content.innerHTML += `
          <div class="mb-3">
            <p class="font-semibold text-sm">${esc(ms)}</p>
            <ul class="list-disc ml-4 text-gray-300 text-xs">
              ${courses.map((c) => `<li>${esc(c)}</li>`).join("")}
            </ul>
          </div>
        `;
          });
        } catch (err) {
          console.error("loadLearningPaths error:", err);
          document.getElementById(
            "learningPathContent"
          ).innerHTML = `<p class="text-red-400">‚ùå Unable to load learning path.</p>`;
        }
      }

      // compute a match % between userSkills and a list of required skills (strings)
      function computeMatchPercent(userSkills = [], required = []) {
        const us = userSkills.map((s) => String(s).toLowerCase().trim());
        const req = required.map((s) => String(s).toLowerCase().trim());
        if (req.length === 0) return 0;
        const matched = req.filter((r) => us.includes(r)).length;
        return Math.round((matched / req.length) * 100);
      }

      async function loadOpeningsMatch() {
        try {
          const res = await fetch("http://localhost:4000/api/currentOpenings");
          if (!res.ok) throw new Error("Openings API error");
          const openings = await res.json();

          const container = document.createElement("div");
          container.className = "mt-3";

          const userSkills = window.__userSkills || [];

          if (!Array.isArray(openings) || openings.length === 0) {
            document.getElementById(
              "matchingRolesContent"
            ).innerHTML += `<p class="text-gray-400 mt-2">No current openings found.</p>`;
            return;
          }

          openings.forEach((op) => {
            // try various field names for required skills
            let req = [];
            if (op.requiredSkills && Array.isArray(op.requiredSkills))
              req = op.requiredSkills.map((s) => s.name || s);
            else if (op.RequiredSkills)
              req = String(op.RequiredSkills)
                .split(";")
                .map((s) => s.trim())
                .filter(Boolean);
            else if (op.skills)
              req = Array.isArray(op.skills)
                ? op.skills.map((s) => s.name || s)
                : String(op.skills)
                    .split(";")
                    .map((s) => s.trim());
            else if (op.skill_list)
              req = String(op.skill_list)
                .split(",")
                .map((s) => s.trim());
            else if (op.skills_text)
              req = String(op.skills_text)
                .split(";")
                .map((s) => s.trim());
            else {
              // last fallback: try to pick any string fields that look like skills
              req = [];
            }

            const matchPct = computeMatchPercent(userSkills, req);
            const title =
              op.title || op.role || op.position || op.name || "Opening";

            container.innerHTML += `
          <div class="mb-2 p-2 bg-[#1f1f1f] rounded-md">
            <div class="flex justify-between">
              <div>
                <p class="font-semibold">${esc(title)}</p>
                <p class="text-xs text-gray-400">Skills: ${esc(
                  req.join(", ") || "Not specified"
                )}</p>
              </div>
              <div class="text-right">
                <p class="font-bold">${esc(matchPct)}%</p>
              </div>
            </div>
          </div>
        `;
          });

          // append under matchingRolesContent (after roles)
          document.getElementById("matchingRolesContent").innerHTML += `
        <div class="mt-4">
          <p class="text-gray-300 font-semibold mb-2">Current Openings Matches</p>
        </div>
      `;
          document
            .getElementById("matchingRolesContent")
            .appendChild(container);
        } catch (err) {
          console.error("loadOpeningsMatch error:", err);
          document.getElementById(
            "matchingRolesContent"
          ).innerHTML += `<p class="text-red-400 mt-3">‚ùå Unable to load openings.</p>`;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadCareerInsights();
        loadMatchingRoles().then(() => loadOpeningsMatch());
        // learning paths depends on missingSkills, wait a touch (we can't wait async in background, but this is best-effort)
        setTimeout(loadLearningPaths, 400);
      });
    </script>
  </body>
</html>
